# Supabase REST API Smoke Test

This document provides curl commands to test basic functionality of the Supabase REST API with the `leads` table using the service role key.

## Environment Setup

First, export the required Supabase environment variables:

```bash
export SUPABASE_URL="your_supabase_project_url_here"
export SUPABASE_SERVICE_ROLE="your_service_role_key_here"
```

Replace the placeholder values with your actual Supabase project URL and service role key:
- `SUPABASE_URL`: Your Supabase project URL (e.g., `https://your-project-id.supabase.co`)
- `SUPABASE_SERVICE_ROLE`: Your Supabase service role key (starts with `eyJ...`)

## Read from Leads Table

### Get All Leads

```bash
curl -X GET "${SUPABASE_URL}/rest/v1/leads" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json"
```

### Get Leads with Filtering

Get leads with status 'new':

```bash
curl -X GET "${SUPABASE_URL}/rest/v1/leads?status=eq.new" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json"
```

### Get Single Lead by ID

```bash
curl -X GET "${SUPABASE_URL}/rest/v1/leads?id=eq.1" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json"
```

## Insert into Leads Table

### Insert a New Lead

```bash
curl -X POST "${SUPABASE_URL}/rest/v1/leads" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=representation" \
  -d '{
    "source": "smoke_test",
    "name": "John Doe",
    "phone": "+1-555-123-4567",
    "email": "john.doe@example.com",
    "address": "123 Main Street",
    "city": "Houston",
    "state": "TX",
    "zip": "77001",
    "status": "new"
  }'
```

### Insert Multiple Leads

```bash
curl -X POST "${SUPABASE_URL}/rest/v1/leads" \
  -H "apikey: ${SUPABASE_SERVICE_ROLE}" \
  -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE}" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=representation" \
  -d '[
    {
      "source": "smoke_test_batch",
      "name": "Jane Smith",
      "phone": "+1-555-234-5678",
      "email": "jane.smith@example.com",
      "address": "456 Oak Avenue",
      "city": "Dallas",
      "state": "TX",
      "zip": "75201",
      "status": "new"
    },
    {
      "source": "smoke_test_batch",
      "name": "Bob Johnson",
      "phone": "+1-555-345-6789",
      "email": "bob.johnson@example.com",
      "address": "789 Pine Road",
      "city": "Austin",
      "state": "TX",
      "zip": "73301",
      "status": "new"
    }
  ]'
```

## Expected Responses

### Successful GET Response
```json
[
  {
    "id": 1,
    "created_at": "2024-01-01T12:00:00.000Z",
    "source": "smoke_test",
    "name": "John Doe",
    "phone": "+1-555-123-4567",
    "email": "john.doe@example.com",
    "address": "123 Main Street",
    "city": "Houston",
    "state": "TX",
    "zip": "77001",
    "status": "new"
  }
]
```

### Successful POST Response
```json
[
  {
    "id": 2,
    "created_at": "2024-01-01T12:05:00.000Z",
    "source": "smoke_test",
    "name": "John Doe",
    "phone": "+1-555-123-4567",
    "email": "john.doe@example.com",
    "address": "123 Main Street",
    "city": "Houston",
    "state": "TX",
    "zip": "77001",
    "status": "new"
  }
]
```

## Notes

- The service role key bypasses Row Level Security (RLS) policies and provides full access to the database
- Always use the service role key on the server-side only, never expose it in client-side code
- The `Prefer: return=representation` header returns the inserted data in the response
- All timestamps are automatically generated by the database using `now()`
- The `id` field is auto-generated using `bigserial`

## Troubleshooting

### Common Error Responses

**401 Unauthorized:**
```json
{"message": "Invalid API key"}
```
- Check that your `SUPABASE_SERVICE_ROLE` is correctly set and valid

**404 Not Found:**
```json
{"message": "relation \"public.leads\" does not exist"}
```
- Verify that the leads table has been created using the migration script
- Check that your `SUPABASE_URL` is correct

**422 Unprocessable Entity:**
```json
{"message": "new row violates row-level security policy"}
```
- This shouldn't happen with service role key, but check your RLS policies if it occurs