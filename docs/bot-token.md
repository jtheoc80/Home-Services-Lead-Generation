# BOT_TOKEN Setup Guide

This document provides step-by-step instructions for creating and configuring a Fine-grained Personal Access Token (PAT) for use as `BOT_TOKEN` in GitHub Actions workflows.

## Overview

The `BOT_TOKEN` is used for automated GitHub operations that require write permissions to repository contents and pull requests. This token enables workflows to:

- Create and update files in the repository
- Create and manage pull requests
- Perform automated code changes and updates

## Step 1: Create Fine-grained Personal Access Token

### 1. Navigate to Token Settings

1. **Go to GitHub Settings**:
   - Click your profile picture → Settings → Developer settings
   - Select "Personal access tokens" → "Fine-grained tokens"
   - Click "Generate new token"

### 2. Configure Token Settings

**Basic Information:**
```
Token name: Your-Repository-Bot-Token
Expiration: 90 days (or per your security policy)
Description: Bot token for automated content and PR operations

### 3. Configure Repository Permissions

Set the following permissions for the selected repository:

| Permission Category | Specific Permission | Access Level | Purpose |
|-------------------|-------------------|--------------|---------|
| **Repository permissions** | | | |
| Contents | Contents | **Read and write** | Read and modify repository files |
| Pull requests | Pull requests | **Read and write** | Create and manage pull requests |
| Metadata | Metadata | **Read** | Access repository metadata |

**Required permissions in JSON format:**
```json
{
  "contents": "write",
  "pull_requests": "write", 
  "metadata": "read"
}
```

### 4. Generate and Secure Token

1. **Generate the token**:
   - Review permissions carefully
   - Click "Generate token"
   - **Copy the token immediately** (it will only be shown once)

2. **Token format example**:
   ```bash
   # Example token format (not a real token)
   github_pat_11ABCDEFG_xyzabcdefghijklmnopqrstuvwxyz123456789
   ```

## Step 2: Add Token to Repository Secrets

### GitHub Web Interface

1. **Navigate to repository settings**:
   - Go to your repository: `jtheoc80/Home-Services-Lead-Generation`
   - Click "Settings" → "Secrets and variables" → "Actions"

2. **Add new repository secret**:
   - Click "New repository secret"
   - **Name**: `BOT_TOKEN`
   - **Value**: Paste your Fine-grained PAT token
   - Click "Add secret"

### Local CLI Method

You can also add the secret using GitHub CLI:

```bash
gh secret set BOT_TOKEN --body '<paste your PAT>'
```

**Example:**
```bash
# Replace with your actual token
gh secret set BOT_TOKEN --body 'github_pat_11ABCDEFG_xyzabcdefghijklmnopqrstuvwxyz123456789'
```

## Step 3: Verify Token Setup

### Test Token Access

```bash
# Test repository access
curl -H "Authorization: token github_pat_11ABCDEFG_xyz..." \
  https://api.github.com/repos/jtheoc80/Home-Services-Lead-Generation

# Test pull request permissions
curl -H "Authorization: token github_pat_11ABCDEFG_xyz..." \
  https://api.github.com/repos/jtheoc80/Home-Services-Lead-Generation/pulls
```

### Check Secret Configuration

1. **Verify in GitHub**:
   - Go to Settings → Secrets and variables → Actions
   - Confirm `BOT_TOKEN` appears in the list
   - Secret value should show as "Updated X time ago"

2. **Test in workflow**:
   ```yaml
   # Example workflow usage
   - name: Test BOT_TOKEN access
     env:
       GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
     run: |
       gh api user
   ```

## Usage in Workflows

### Basic Usage

```yaml
steps:
  - name: Checkout with BOT_TOKEN
    uses: actions/checkout@v5
    with:
      token: ${{ secrets.BOT_TOKEN }}
      
  - name: Create Pull Request
    env:
      GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
    run: |
      gh pr create --title "Automated Update" --body "Generated by bot"
```

### When to Use BOT_TOKEN vs GITHUB_TOKEN

| Operation | Use Token | Reason |
|-----------|-----------|---------|
| **Automated content updates** | `BOT_TOKEN` | Requires write access to contents |
| **Creating pull requests** | `BOT_TOKEN` | Requires PR write permissions |
| **Reading repository data** | Either | Both have read access |
| **Manual workflows** | `GITHUB_TOKEN` | Human-initiated actions |

## Security Best Practices

### Token Security

- ✅ **Never commit tokens to code**
- ✅ **Use repository secrets for storage**
- ✅ **Set appropriate expiration dates**
- ✅ **Use minimum required permissions**
- ✅ **Regular token rotation**

### Monitoring

- Review token usage in repository audit logs
- Monitor for unexpected repository modifications
- Set up alerts for failed authentication attempts

## Troubleshooting

### Common Issues

1. **"Bad credentials" error**:
   - Verify token was copied correctly
   - Check token hasn't expired
   - Ensure repository access is configured

2. **"Insufficient permissions" error**:
   - Verify Contents and Pull requests permissions are set to "Write"
   - Check repository is selected in token configuration

3. **"Resource not accessible" error**:
   - Confirm repository name is correct
   - Verify token has access to the specific repository

### Getting Help

- Check the [GitHub Fine-grained PAT documentation](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token#creating-a-fine-grained-personal-access-token)
- Review repository audit logs for authentication failures
- Contact repository administrators for access issues

---

**Related Documentation:**
- [Stack Monitor Bot Setup](ops/stack-monitor-bot.md) - Comprehensive bot setup guide
- [Workflow Secrets Configuration](workflows-secrets.md) - Other required secrets