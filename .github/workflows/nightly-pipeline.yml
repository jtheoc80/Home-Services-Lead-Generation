name: Nightly Pipeline

on:
  schedule:
    # Midnight America/Chicago during DST (5 AM UTC)
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  scrape_and_export:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install permit_leads dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r permit_leads/requirements.txt
          
      - name: Create output directory
        run: |
          mkdir -p out
          
      - name: Run scraper (last 14 days)
        run: |
          python -m permit_leads scrape --all --days 14 --output-dir out --formats csv sqlite
          
      - name: Export leads
        run: |
          python -m permit_leads export-leads --db out/permits/permits.db --out out --lookback 14
          
      - name: Upload leads_recent.csv artifact
        uses: actions/upload-artifact@v4
        with:
          name: leads-recent
          path: out/leads_recent.csv
          if-no-files-found: warn
          
      - name: Upload leads_by_jurisdiction artifacts
        uses: actions/upload-artifact@v4
        with:
          name: leads-by-jurisdiction
          path: out/by_jurisdiction/*.csv
          if-no-files-found: warn

  ingest_to_postgres:
    runs-on: ubuntu-latest
    needs: scrape_and_export
    
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          
      - name: Download leads artifacts
        uses: actions/download-artifact@v4
        with:
          name: leads-recent
          path: out/
          
      - name: Run schema setup
        run: |
          python -c "
          import psycopg2
          import os
          
          # Read and execute the schema
          with open('backend/app/models.sql', 'r') as f:
              schema_sql = f.read()
          
          # Connect to database and execute schema
          conn = psycopg2.connect(os.environ['DATABASE_URL'])
          cur = conn.cursor()
          cur.execute(schema_sql)
          conn.commit()
          cur.close()
          conn.close()
          print('Schema setup completed')
          "
          
      - name: Ingest leads to PostgreSQL
        run: |
          python -m backend.app.ingest out/leads_recent.csv