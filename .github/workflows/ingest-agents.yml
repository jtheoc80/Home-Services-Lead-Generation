
name: Ingest Agents (Austin/Dallas)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual data insertion)'
        required: false
        default: 'false'
        type: boolean
  
  # Scheduled trigger (every 6 hours)
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours

env:
  VERCEL_DOMAIN: ${{ secrets.VERCEL_DOMAIN }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}

jobs:
  ingest:
    runs-on: ubuntu-latest

    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        source: [austin, dallas, houston, san_antonio]
    
    steps:
    - name: Validate environment
      run: |
        if [ -z "${{ env.CRON_SECRET }}" ]; then
          echo "âŒ CRON_SECRET secret not configured"
          exit 1
        fi
        if [ -z "${{ env.VERCEL_DOMAIN }}" ]; then
          echo "âŒ VERCEL_DOMAIN secret not configured"
          exit 1
        fi
        echo "âœ… Environment validated for source: ${{ matrix.source }}"
        
    - name: Trigger permit ingestion for ${{ matrix.source }}
      id: ingest
      run: |
        SOURCE="${{ matrix.source }}"
        DRY_RUN="${{ inputs.dry_run }}"
        [ -z "$DRY_RUN" ] && DRY_RUN="false"
        
        echo "ðŸš€ Triggering permit ingestion for source: $SOURCE"
        echo "ðŸ§ª Dry run mode: $DRY_RUN"
        echo "ðŸ“¡ Target: https://${{ env.VERCEL_DOMAIN }}/api/permits/permits/ingest"
        
        # Prepare URL with query parameters
        URL="https://${{ env.VERCEL_DOMAIN }}/api/permits/permits/ingest?source=$SOURCE"
        if [ "$DRY_RUN" == "true" ]; then
          URL="$URL&dry=1"
        fi
        
        echo "ðŸ“ž Making request to: $URL"
        
        # Make the API call to the permits ingest endpoint
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "x-cron-secret: ${{ env.CRON_SECRET }}" \
          "$URL")
        
        # Extract status code from response
        HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
        
        echo "ðŸ“Š HTTP Status: $HTTP_STATUS"
        echo "ðŸ“‹ Response:"
        echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
        
        # Check if successful
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "âœ… Permit ingestion completed successfully for $SOURCE"
          
          # Extract summary information if available
          FETCHED=$(echo "$RESPONSE_BODY" | jq -r '.fetched // "N/A"' 2>/dev/null)
          UPSERTS=$(echo "$RESPONSE_BODY" | jq -r '.upserts // "N/A"' 2>/dev/null)
          BEFORE_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.beforeCount // "N/A"' 2>/dev/null)
          AFTER_COUNT=$(echo "$RESPONSE_BODY" | jq -r '.afterCount // "N/A"' 2>/dev/null)
          ERRORS=$(echo "$RESPONSE_BODY" | jq -r '.errors | length // 0' 2>/dev/null)
          
          echo "summary_fetched=$FETCHED" >> $GITHUB_OUTPUT
          echo "summary_upserts=$UPSERTS" >> $GITHUB_OUTPUT
          echo "summary_before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "summary_after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          echo "summary_errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Permit ingestion failed for $SOURCE with status: $HTTP_STATUS"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      
    - name: Step Summary for ${{ matrix.source }}
      if: always()
      run: |
        # Determine status with shell conditional
        if [ "${{ steps.ingest.outputs.success }}" == "true" ]; then
          STATUS="âœ… Success"
        else
          STATUS="âŒ Failed"
        fi
        
        # Build dry run value with shell default
        DRY_RUN="${{ inputs.dry_run }}"
        [ -z "$DRY_RUN" ] && DRY_RUN="false"
        
        echo "## Ingest Summary: ${{ matrix.source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Source**: ${{ matrix.source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Dry Run**: $DRY_RUN" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: $STATUS" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.ingest.outputs.success }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Fetched**: ${{ steps.ingest.outputs.summary_fetched }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Upserts**: ${{ steps.ingest.outputs.summary_upserts }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Before Count**: ${{ steps.ingest.outputs.summary_before_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **After Count**: ${{ steps.ingest.outputs.summary_after_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Errors**: ${{ steps.ingest.outputs.summary_errors }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

