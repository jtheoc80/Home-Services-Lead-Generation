
name: Stack Monitor

on:
  schedule:
    # Run every 10 minutes
    - cron: "*/10 * * * *"
  workflow_dispatch:
    inputs:
      force_remediation:
        description: 'Force auto-remediation even if disabled'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  issues: write
  actions: write

jobs:
  stack-health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run stack health check
        id: health_check
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          # Set AUTO_REMEDIATE using shell default instead of logical OR
          AUTO_REMEDIATE="${{ vars.AUTO_REMEDIATE }}"
          [ -z "$AUTO_REMEDIATE" ] && AUTO_REMEDIATE="false"
          export AUTO_REMEDIATE
          
          # Run health check and capture output
          echo "Running stack health check..."
          node scripts/stack-health.js > health-summary.md 2>health-stderr.log || echo "Health check completed with issues"
          
          # Check backend /healthz endpoint for Stripe status
          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            echo "Checking backend Stripe status..."
            curl -s "${{ secrets.BACKEND_URL }}/healthz" | jq '.stripe' > stripe-status.txt
            stripe_status=$(cat stripe-status.txt | tr -d '"')
            
            if [ "$stripe_status" != "configured" ]; then
              echo "❌ Stripe health check failed: $stripe_status" >> health-summary.md
              echo "stripe_health_failed=true" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "✅ Stripe health check passed" >> health-summary.md
              echo "stripe_health_failed=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Check if health check passed based on exit code
          if [ $? -eq 0 ]; then
            echo "health_check_failed=false" >> $GITHUB_OUTPUT
          else
            echo "health_check_failed=true" >> $GITHUB_OUTPUT
          fi
          
          # Always append summary to GitHub Step Summary
          if [ -f "health-summary.md" ]; then
            cat health-summary.md >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Redis smoketest
        if: env.REDIS_URL != ''
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          echo "Running Redis smoketest..."
          python scripts/redis_smoketest.py || echo "Redis smoketest failed"
        
      - name: Create Stripe Health Alert issue
        if: steps.health_check.outputs.stripe_health_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Stripe Health Alert';
            const body = `## ⚠️ Stripe Configuration Issue Detected
            
            The Stripe payment system is not properly configured or accessible.
            
            ### Remediation Steps:
            
            1. **Check Railway Environment Variables:**
               \`\`\`bash
               railway variables get STRIPE_SECRET_KEY
               railway variables get STRIPE_WEBHOOK_SECRET
               \`\`\`
            
            2. **Verify Stripe API Key:**
               - Log into Stripe Dashboard
               - Check that the API key is valid and has proper permissions
               - Ensure you're using the correct environment (test vs live)
            
            3. **Test Connectivity:**
               \`\`\`bash
               curl "${{ secrets.BACKEND_URL }}/healthz"
               \`\`\`
            
            4. **Check Logs:**
               - Review Railway deployment logs for Stripe-related errors
               - Look for authentication or network issues
            
            ### Environment Variables Required:
            - \`STRIPE_SECRET_KEY\`: Server-side Stripe API key
            - \`STRIPE_WEBHOOK_SECRET\`: Webhook signature verification secret
            - \`STRIPE_PRICE_STARTER_MONTHLY\`: Starter plan price ID
            - \`STRIPE_PRICE_PRO_MONTHLY\`: Pro plan price ID
            - \`STRIPE_PRICE_LEAD_CREDIT_PACK\`: Credit pack price ID
            
            ---
            **Detected at:** ${new Date().toISOString()}
            **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            // Search for existing Stripe health issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc'
            });
            
            // Replace strict equality with loose equality
            const existingIssue = issues.find(issue => 
              issue.title == title && 
              issue.user.type == 'Bot'
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body,
                labels: ['bug', 'stripe', 'infrastructure', 'automated']
              });
              
              console.log(\`Updated existing Stripe health issue #\${existingIssue.number}\`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'stripe', 'infrastructure', 'automated']
              });
              
              console.log(\`Created new Stripe health issue #\${issue.number}\`);
            }

      - name: Check for build/config issues and dispatch AI Auto PR
        if: steps.health_check.outputs.health_check_failed == 'true'
        id: check_build_issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read stderr output if it exists
            let stderrContent = '';
            if (fs.existsSync('health-stderr.log')) {
              stderrContent = fs.readFileSync('health-stderr.log', 'utf8');
              console.log('Stderr content:', stderrContent);
            }
            
            // Define patterns that indicate Next.js/Supabase build/config issues
            const buildConfigPatterns = [
              'supabaseKey is required',
              'NEXT_PUBLIC_.*missing',
              'NEXT_PUBLIC_.*not.*found',
              'SIGTERM port not bound',
              'Port.*already.*in.*use',
              'client.*supabase.*init',
              'SUPABASE_.*required'
            ];
            
            // Check if any patterns match
            let hasConfigIssue = false;
            for (const pattern of buildConfigPatterns) {
              const regex = new RegExp(pattern, 'i');
              if (regex.test(stderrContent)) {
                console.log(`Found config issue pattern: ${pattern}`);
                hasConfigIssue = true;
                break;
              }
            }
            
            if (hasConfigIssue) {
              console.log('Build/config issues detected, dispatching AI Auto PR...');
              
              // Dispatch the AI Auto PR workflow
              const instruction = "Fix Next/Supabase build: client-only Supabase init, ensure NEXT_PUBLIC_SUPABASE_* client-side only, add /api/health, use Next standalone Dockerfile for Railway.";
              
              await github.rest.repos.createDispatchEvent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                event_type: 'ai_autopr_request',
                client_payload: {
                  instruction: instruction,
                  error_type: 'build_config',
                  triggered_by: 'stack-monitor',
                  stderr_content: stderrContent.substring(0, 1000) // Limit size
                }
              });
              
              console.log('AI Auto PR workflow dispatched successfully');
              
              // Add this info to the step summary
              const summary = `
              
              ## 🤖 AI Auto PR Triggered
              
              Build/configuration issues detected in stack health check stderr. 
              Automatically dispatched AI Auto PR workflow with instruction:
              
              > ${instruction}
              
              **Event Type:** ai_autopr_request  
              **Triggered By:** stack-monitor workflow
              `;
              
              require('fs').appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            } else {
              console.log('No specific build/config issues detected in stderr');
            }

      - name: Upload stack health artifacts
        if: steps.health_check.outputs.health_check_failed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: stack-health-report-${{ github.run_number }}
          path: |
            stack-health.json
            health-summary.md
            health-stderr.log
          retention-days: 30
          if-no-files-found: warn
          
      - name: Create or update GitHub issue
        if: steps.health_check.outputs.health_check_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the generated summary
            let summary = '## Stack Monitor Alert\n\nStack health check failed. Please review the details below.\n\n';
            if (fs.existsSync('health-summary.md')) {
              summary = fs.readFileSync('health-summary.md', 'utf8');
            }
            
            // Add metadata
            const metadata = `
            
            ---
            
            **Run Details:**
            - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Triggered by:** ${{ github.event_name }}
            - **Timestamp:** ${new Date().toISOString()}
            - **Branch:** ${{ github.ref_name }}
            - **Commit:** ${{ github.sha }}
            
            *This issue was automatically generated by the Stack Monitor workflow.*
            `;
            
            const title = 'Stack Monitor Alert';
            const body = summary + metadata;
            
            // Search for existing issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc'
            });
            
            // Replace strict equality with loose equality
            const existingIssue = issues.find(issue => 
              issue.title == title && 
              issue.user.type == 'Bot'
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body,
                labels: ['bug', 'infrastructure', 'automated']
              });
              
              // Add comment with latest update
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `### 🔄 Stack Monitor Update\n\n**Run #${{ github.run_number }}** detected continued issues.\n\nSee updated issue description for latest details.`
              });
              
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'infrastructure', 'automated']
              });
              
              console.log(`Created new issue #${issue.number}`);
            }
            
      - name: Auto-remediation (if enabled)
        if: |
          steps.health_check.outputs.health_check_failed == 'true' && 
          (vars.AUTO_REMEDIATE == 'true' || github.event.inputs.force_remediation == 'true')
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          echo "🔧 Auto-remediation is enabled, attempting to fix issues..."
          
          # Check if remediation scripts exist and run them
          if [ -f "scripts/remediate-vercel.js" ]; then
            echo "Running Vercel remediation..."
            node scripts/remediate-vercel.js || echo "Vercel remediation failed"
          fi
          
          if [ -f "scripts/remediate-railway.js" ]; then
            echo "Running Railway remediation..."
            node scripts/remediate-railway.js || echo "Railway remediation failed"
          fi
          
          # Wait a bit and re-run health check to see if issues were resolved
          echo "Waiting 30 seconds before re-checking..."
          sleep 30
          
          echo "Re-running health check after remediation..."
          node scripts/stack-health.js > remediation-summary.md || true
          
          if [ -f "remediation-summary.md" ]; then
            echo "## Post-Remediation Results" >> $GITHUB_STEP_SUMMARY
            cat remediation-summary.md >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Close resolved issues
        if: steps.health_check.outputs.health_check_failed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Stack Monitor Alert';
            
            // Search for open Stack Monitor issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc'
            });
            
            // Replace strict equality with loose equality
            const stackIssues = issues.filter(issue => 
              issue.title == title && 
              issue.user.type == 'Bot'
            );
            
            for (const issue of stackIssues) {
              // Add resolution comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `### ✅ Issue Resolved\n\n**Run #${{ github.run_number }}** confirmed all services are healthy.\n\nClosing this issue automatically.`
              });
              
              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed'
              });
              
              console.log(`Closed resolved issue #${issue.number}`);
            }
            
      - name: Report workflow summary
        if: always()
        run: |
          # Use shell logic instead of ternary expressions
          if [ "${{ steps.health_check.outputs.health_check_failed }}" = "false" ]; then
            HEALTH_STATUS="✅ Passed"
          else
            HEALTH_STATUS="❌ Failed"
          fi
          
          if [ "${{ vars.AUTO_REMEDIATE }}" = "true" ]; then
            AUTO_REMEDIATE_STATUS="✅ Enabled"
          else
            AUTO_REMEDIATE_STATUS="❌ Disabled"
          fi
          
          echo "## Stack Monitor Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check Result:** $HEALTH_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-remediation:** $AUTO_REMEDIATE_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY

