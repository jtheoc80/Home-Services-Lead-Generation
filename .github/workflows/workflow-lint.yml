name: Workflow Lint

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  lint-workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install PyYAML

      - name: Lint workflow YAML syntax
        run: |
          echo "🔍 Linting GitHub Actions workflow files..."
          
          # Find all workflow files
          workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml")
          
          if [ -z "$workflow_files" ]; then
            echo "No workflow files found"
            exit 0
          fi
          
          total_files=0
          valid_files=0
          invalid_files=()
          
          for file in $workflow_files; do
            total_files=$((total_files + 1))
            echo "Checking: $file"
            
            if python3 -c "import yaml; yaml.safe_load(open('$file').read())" 2>/dev/null; then
              echo "  ✅ Valid YAML"
              valid_files=$((valid_files + 1))
            else
              echo "  ❌ Invalid YAML"
              invalid_files+=("$file")
              
              # Show detailed error
              echo "  Error details:"
              python3 -c "import yaml; yaml.safe_load(open('$file').read())" 2>&1 | sed 's/^/    /'
            fi
            echo ""
          done
          
          # Summary
          echo "📊 Workflow Lint Summary:"
          echo "  Total files: $total_files"
          echo "  Valid: $valid_files"
          echo "  Invalid: $((total_files - valid_files))"
          
          if [ ${#invalid_files[@]} -gt 0 ]; then
            echo ""
            echo "❌ Invalid workflow files:"
            for file in "${invalid_files[@]}"; do
              echo "  - $file"
            done
            exit 1
          else
            echo ""
            echo "✅ All workflow files have valid YAML syntax!"
          fi

      - name: Check for required workflow elements
        run: |
          echo "🔍 Checking for required workflow elements..."
          
          workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml")
          issues=()
          
          for file in $workflow_files; do
            echo "Analyzing: $file"
            
            # Check if workflow has a name
            if ! grep -q "^name:" "$file"; then
              issues+=("$file: Missing 'name' field")
            fi
            
            # Check if workflow has jobs
            if ! grep -q "^jobs:" "$file"; then
              issues+=("$file: Missing 'jobs' section")
            fi
            
            # Check for potential security issues
            if grep -q "pull_request_target" "$file"; then
              echo "  ⚠️  Uses pull_request_target - ensure proper security measures"
            fi
            
            if grep -q "\${{ github.event.pull_request.head.ref }}" "$file"; then
              echo "  ⚠️  Uses PR head ref - ensure this is safe"
            fi
          done
          
          if [ ${#issues[@]} -gt 0 ]; then
            echo ""
            echo "❌ Workflow issues found:"
            for issue in "${issues[@]}"; do
              echo "  - $issue"
            done
            exit 1
          else
            echo ""
            echo "✅ All workflows have required elements!"
          fi

      - name: Generate lint report
        if: always()
        run: |
          echo "## 🔍 Workflow Lint Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          workflow_count=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "**Total workflows checked:** $workflow_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Workflows:" >> $GITHUB_STEP_SUMMARY
          find .github/workflows -name "*.yml" -o -name "*.yaml" | sort | while read file; do
            if python3 -c "import yaml; yaml.safe_load(open('$file').read())" 2>/dev/null; then
              echo "- ✅ \`$file\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ \`$file\`" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run time:** $(date)" >> $GITHUB_STEP_SUMMARY