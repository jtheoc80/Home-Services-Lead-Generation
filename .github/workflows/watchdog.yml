---
name: Watchdog
"on":
  schedule: [{ cron: "*/30 * * * *" }]
  workflow_dispatch:

jobs:
  freshness:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Check last 24h counts (REST)
        run: |
          python - <<'PY'
          import os, requests, datetime
          today = datetime.date.today().isoformat()
          url = f"{os.environ['SUPABASE_URL']}/rest/v1/permits?select=count&issue_date=gte.{today}"
          h = {"apikey":os.environ["SUPABASE_SERVICE_ROLE_KEY"],
               "Authorization":"Bearer "+os.environ["SUPABASE_SERVICE_ROLE_KEY"],
               "Prefer":"count=exact"}
          r = requests.get(url, headers=h, timeout=15)
          print("content-range:", r.headers.get("content-range"))
          PY

