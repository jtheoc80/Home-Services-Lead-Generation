name: Nightly ETL Guardian Bot

on:
  workflow_run:
    workflows: ["Nightly ETL"]
    types: [completed]
  schedule:
    - cron: "12 7 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  guardian:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install fixer deps
        run: |
          python -m pip install --upgrade pip
          echo 'ruamel.yaml==0.18.6' > tools/requirements.txt
          pip install -r tools/requirements.txt

      - name: Run fixer (writes changes if needed)
        id: guardian
        run: |
          python tools/etl_guardian.py --write || true
          # did we modify the workflow file?
          if git diff --quiet .github/workflows/etl.yml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # record whether BOT_TOKEN is set without using it in "if:"
      - name: Flag BOT_TOKEN presence
        run: echo "BOT_TOKEN_SET=${{ secrets.BOT_TOKEN != '' }}" >> $GITHUB_ENV

      - name: Create or update PR
        if: ${{ steps.guardian.outputs.changed == 'true' }}
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BOT_TOKEN || github.token }}
          branch: bot/fix-etl
          commit-message: "bot(etl): auto-fix nightly workflow (ingest guard, mkdir, log path, artifacts, concurrency)"
          title: "Nightly ETL Bot: auto-fix workflow"
          body: |
            Automated fixes for `.github/workflows/etl.yml`:
            - Ensure output dirs (logs/artifacts/data)
            - Conditional ingestion (records>0 OR force=true)
            - Correct log tail (logs/etl_output.log)
            - Single artifact uploader with stable globs
            - Concurrency guard

      - name: Auto-approve
        if: ${{ steps.guardian.outputs.changed == 'true' && env.BOT_TOKEN_SET == 'true' }}
        uses: peter-evans/approve-pull-request@v3
        with:
          token: ${{ secrets.BOT_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}

      - name: Enable auto-merge (squash)
        if: ${{ steps.guardian.outputs.changed == 'true' && env.BOT_TOKEN_SET == 'true' && steps.create_pr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.BOT_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: squash
