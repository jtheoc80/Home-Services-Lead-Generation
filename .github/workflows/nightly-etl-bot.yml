name: Nightly ETL Guardian Bot
on:
  workflow_run:
    workflows: ["Nightly ETL"]
    types: [completed]
  schedule:
    - cron: "12 7 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install fixer deps
        run: |
          python -m pip install --upgrade pip
          echo 'ruamel.yaml==0.18.6' > tools/requirements.txt
          pip install -r tools/requirements.txt

      - name: Run fixer (writes changes if needed)
        id: fix
        run: |
          python tools/etl_guardian.py --write || true
          echo "changed=$(grep -Eo 'CHANGED=true' -m1 tools/etl_guardian.out || true)" >> "$GITHUB_OUTPUT"

      - name: Create or update PR
        if: ${{ steps.fix.outputs.changed != '' }}
        id: create_or_update_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: bot/fix-etl
          commit-message: "bot(etl): auto-fix nightly workflow (ingest guard, mkdir, log path, artifacts, concurrency)"
          title: "Nightly ETL Bot: auto-fix workflow"
          body: |
            This PR was opened by the Nightly ETL Guardian Bot.

            Patches included:
            - Ensure output dirs (logs/artifacts/data)
            - Conditional ingestion (records>0 OR force=true)
            - Correct log tail path (logs/etl_output.log)
            - Single artifact uploader with stable globs
            - Concurrency guard
          labels: |
            bot
            etl
            autofix
          signoff: true

      - name: Auto-approve
        if: ${{ steps.fix.outputs.changed != '' }}
        uses: peter-evans/approve-pull-request@v3
        with:
          token: ${{ secrets.BOT_TOKEN }}
          pull-request-number: ${{ steps.create_or_update_pr.outputs.pull-request-number }}

      - name: Enable auto-merge (squash)
        if: ${{ steps.fix.outputs.changed != '' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.BOT_TOKEN }}
          pull-request-number: ${{ steps.create_or_update_pr.outputs.pull-request-number }}
          merge-method: squash

      - name: Merge now if checks already green (best effort)
        if: ${{ steps.fix.outputs.changed != '' }}
        run: |
          echo "Attempting immediate merge (if allowed)â€¦"
          gh pr merge ${{ steps.create_or_update_pr.outputs.pull-request-number }} --squash --auto --repo "$GITHUB_REPOSITORY" || true
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}