name: Nightly ETL Guardian Bot

on:
  workflow_run:
    workflows: ["Nightly ETL"]
    types: [completed]
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"
  BOT_TOKEN: ${{ secrets.BOT_TOKEN }}

jobs:
  guardian:
    runs-on: ubuntu-latest
    steps:
      - name: Create output directories
        run: |
          mkdir -p logs artifacts
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.BOT_TOKEN || github.token }}
          fetch-depth: 0

      - name: Check BOT_TOKEN availability
        id: check-token
        run: |
          if [ -n "$BOT_TOKEN" ]; then
            echo "has-bot-token=true" >> $GITHUB_OUTPUT
            echo "BOT_TOKEN is available for enhanced features"
          else
            echo "has-bot-token=false" >> $GITHUB_OUTPUT
            echo "Using github.token - some features may be limited"
          fi

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install fixer deps
        run: |
          python -m pip install --upgrade pip
          if [ -f "tools/requirements.txt" ]; then
            pip install -r tools/requirements.txt
          else
            echo 'ruamel.yaml==0.18.6' > tools/requirements.txt
            pip install -r tools/requirements.txt
          fi

      - name: Run fixer (writes changes if needed)
        id: guardian
        run: |
          python tools/etl_guardian.py --write 2>&1 | tee logs/etl_output.log || true
          # Check if we modified the ETL workflow file
          if git diff --quiet .github/workflows/etl.yml; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi


      # record whether BOT_TOKEN is set without using it in "if:"
      - name: Flag BOT_TOKEN presence
        run: echo "BOT_TOKEN_SET=${{ env.BOT_TOKEN != '' }}" >> $GITHUB_ENV

      - name: Create Pull Request
        if: steps.guardian.outputs.changed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ env.BOT_TOKEN || github.token }}
          branch: bot/etl-guardian-fixes
          commit-message: "ci(bot): auto-fix ingest workflow"
          title: "Nightly ETL Bot: auto-fixes"
          body: |
            Automated fixes for `.github/workflows/ingest-nightly.yml`:
            - Ensure output dirs (logs/artifacts/data)
            - Conditional ingestion (records>0 OR force=true)
            - Correct log tail (logs/etl_output.log)
            - Single artifact uploader with stable globs
            - Concurrency guard
          delete-branch: true


      - name: Auto-approve PR
        if: ${{ steps.guardian.outputs.changed == 'true' && env.BOT_TOKEN_SET == 'true' }}
        uses: juliangruber/approve-pull-request-action@v2
        with:
          token: ${{ env.BOT_TOKEN }}
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}

      - name: Enable auto-merge (squash)
        if: ${{ steps.guardian.outputs.changed == 'true' && env.BOT_TOKEN_SET == 'true' && steps.create-pr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ env.BOT_TOKEN }}
          pull-request-number: ${{ steps.create-pr.outputs.pull-request-number }}
          merge-method: squash

      - name: Summary
        if: always()
        run: |
          echo "## ETL Guardian Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow checked**: .github/workflows/etl.yml" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.guardian.outputs.changed }}" == "true" ]; then
            echo "- **Status**: ⚠️ Issues found and fixed" >> $GITHUB_STEP_SUMMARY
            echo "- **Action**: PR created for auto-fix" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
              echo "- **PR**: #${{ steps.create-pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Status**: ✅ No issues found" >> $GITHUB_STEP_SUMMARY
            echo "- **Action**: No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **BOT_TOKEN**: ${{ env.BOT_TOKEN_SET == 'true' && 'Available' || 'Not available' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Upload ETL logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: etl-logs-${{ github.job }}-${{ github.run_id }}
          path: |
            logs/**/*.log
            artifacts/**/*
          if-no-files-found: warn

